package org.metro.DAO;

import org.metro.model.NhanVienModel;
import org.metro.model.PhanQuyenModel.NhomQuyenModel;
import org.metro.model.TaiKhoanModel;
import org.metro.util.DatabaseUtils;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class TaiKhoanDAO implements IBaseDAO<TaiKhoanModel> {
    @Override
    public List<TaiKhoanModel> selectAll() {
        List<TaiKhoanModel> list = new ArrayList<>();
        String query = "select tk.manv,tk.matkhau,tk.manhomquyen,tk.trangthai,nq.tennhomquyen\n" +
                "from taikhoan tk join nhomquyen nq on tk.manhomquyen = nq.manhomquyen";
        try (Connection conn = DatabaseUtils.getConnection();
             PreparedStatement stmt = conn.prepareStatement(query);
             ResultSet rs = stmt.executeQuery()) {
            while (rs.next()) {
                NhomQuyenModel nqm = null;
                if(rs.getString("tennhomquyen") != null) {
                    nqm = new NhomQuyenModel(rs.getInt("manhomquyen"),rs.getString("tennhomquyen"));
                }
                TaiKhoanModel tk = new TaiKhoanModel(
                        rs.getInt("manv"),
                        rs.getString("matkhau"),
                        rs.getInt("trangthai"),
                        nqm
                );
                list.add(tk);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    public int insert(TaiKhoanModel tk) {
        String query = "INSERT INTO taikhoan (manv, matkhau, manhomquyen, trangthai) VALUES (?, ?, ?, ?)";
        try(Connection c = DatabaseUtils.getConnection();
            PreparedStatement ps = c.prepareStatement(query);) {
            ps.setInt(1, tk.getManv());
            ps.setString(2, tk.getMatkhau());
            ps.setInt(3, tk.getNqm().getManhomquyen());
            ps.setInt(4, tk.getTrangthai());
            return ps.executeUpdate();
        } catch (Exception e) {
            e.printStackTrace();
            return 0;
        }
    }

    public int update (TaiKhoanModel tk) {
        String query = "UPDATE taikhoan SET matkhau = ?, manhomquyen = ?, trangthai = ? WHERE manv = ?";
        try(Connection c = DatabaseUtils.getConnection();
            PreparedStatement ps = c.prepareStatement(query)) {
            ps.setString(1, tk.getMatkhau());
            ps.setInt(2, tk.getNqm().getManhomquyen());
            ps.setInt(3, tk.getTrangthai());
            ps.setInt(4, tk.getManv());
            System.out.println("trang thai sau khi cap nhat: " + tk.getTrangthai());
            return ps.executeUpdate();
        } catch (Exception e) {
            e.printStackTrace();
            return 0;
        }
    }

    public int delete (int manv) {
        String query = "DELETE FROM taikhoan WHERE manv = ?";
        try(Connection c = DatabaseUtils.getConnection();
            PreparedStatement ps = c.prepareStatement(query);) {
            ps.setInt(1, manv);
            return ps.executeUpdate();
        } catch (Exception e) {
            e.printStackTrace();
            return 0;
        }
    }

    public TaiKhoanModel loginTaiKhoan(String manv,String matkhau) {
        String query = "select tk.manv, tk.matkhau, tk.manhomquyen, tk.trangthai, nq.tennhomquyen " +
                "from taikhoan tk join nhomquyen nq on tk.manhomquyen = nq.manhomquyen " +
                "where tk.manv = ? AND tk.matkhau = ? AND tk.trangthai = 1";
        try(Connection c = DatabaseUtils.getConnection();
            PreparedStatement prs = c.prepareStatement(query);) {
            prs.setString(1,manv);
            prs.setString(2,matkhau);
            ResultSet rs = prs.executeQuery();
            if (rs.next()) {
                NhomQuyenModel nqm = null;
                if (rs.getString("tennhomquyen") != null) {
                    nqm = new NhomQuyenModel(rs.getInt("manhomquyen"), rs.getString("tennhomquyen"));
                }
                return new TaiKhoanModel(rs.getInt("manv"),rs.getString("matkhau"),rs.getInt("trangthai"),nqm);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

    //lay tai khoan theo ma nhom quyen
    public List<TaiKhoanModel> getTaiKhoanByMaNhomQuyen(int manhomquyen) {
        List<TaiKhoanModel> list = new ArrayList<>();
        String query = "SELECT tk.manv, tk.matkhau, tk.manhomquyen, tk.trangthai, nq.tennhomquyen " +
                "FROM taikhoan tk " +
                "LEFT JOIN nhomquyen nq ON tk.manhomquyen = nq.manhomquyen " +
                "WHERE tk.manhomquyen = ?";
        try (Connection conn = DatabaseUtils.getConnection();
             PreparedStatement stmt = conn.prepareStatement(query)) {
            stmt.setInt(1, manhomquyen);
            try (ResultSet rs = stmt.executeQuery()) {
                while (rs.next()) {
                    NhomQuyenModel nqm = null;
                    if (rs.getString("tennhomquyen") != null) {
                        nqm = new NhomQuyenModel(rs.getInt("manhomquyen"), rs.getString("tennhomquyen"));
                    }
                    TaiKhoanModel tk = new TaiKhoanModel(
                            rs.getInt("manv"),
                            rs.getString("matkhau"),
                            rs.getInt("trangthai"),
                            nqm
                    );
                    list.add(tk);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return list;
    }

    @Override
    public TaiKhoanModel selectById(int id) {
        String query = "SELECT * FROM taikhoan WHERE manv = ?";
        try (Connection c = DatabaseUtils.getConnection();
             PreparedStatement prs = c.prepareStatement(query)) {
            prs.setInt(1, id);
            try (ResultSet rs = prs.executeQuery()) {
                if (rs.next()) {
                    int manv = rs.getInt("manv");
                    String matkhau = rs.getString("matkhau");
                    int trangthai = rs.getInt("trangthai");
                    int manhomquyen = rs.getInt("manhomquyen");

                    NhomQuyenModel nqm = new NhomQuyenModel(manhomquyen);

                    return new TaiKhoanModel(manv, matkhau, trangthai, nqm);
                }
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }


}
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































